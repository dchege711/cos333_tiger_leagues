{% extends "base.html" %}
{% block title %}Manage Members{% endblock %}
{% block content %}
    <div class="w3-container large_portrait_margins w3-center">

        <p class="w3-container">
            <strong>{{league_info["league_name"]}} Members</strong>
            <hr>
        </p>

        <div class="w3-container">

            <table class="w3-table-all" id="table_join_requests">

                {% set question_ids = league_info["additional_questions"].keys() %}
                <thead>
                    <tr>
                        <th>Player Name</th>
                        {% for question_id in question_ids %}
                        <th>{{league_info["additional_questions"][question_id]["question"]}}</th>
                        {% endfor %}
                        <th>Status</th>
                    </tr>
                </thead>
                {% set ns = namespace(num_approved_players = 0) %}
                <tbody>
                    {% for join_request in join_requests %}
                    {% if join_request["status"] != "pending" and join_request["status"] != "denied" %}
                        <tr>
                            <td>{{join_request["name"]}}</td>
                            {% for question_id in question_ids %}
                            <td>{{join_request[question_id]}}</td>
                            {% endfor %}
                            <td>
                                <select name="{{join_request['user_id']}}" required>
                                    {% if join_request["status"] == "member" %}
                                        {% set ns.num_approved_players = ns.num_approved_players + 1 %}
                                        <option value="member" selected>Member</option>
                                    {% else %}
                                        <option value="member">Member</option>
                                    {% endif %}
                                    {% if join_request["status"] == "admin" %}
                                        {% set ns.num_approved_players = ns.num_approved_players + 1 %}
                                        <option value="admin" selected>Admin</option>
                                    {% else %}
                                        <option value="admin">Admin</option>
                                    {% endif %}
                                </select>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                
            </table>
            <br />
            <p><span id="num_players">{{ns.num_approved_players}}</span> active players / {{league_info["max_num_players"]}} possible players</p>
            <br />
            <button onclick="document.location = './../'" class="w3-button w3-round w3-orange w3-left">Back to Admin Page</button>
            <button onclick="saveTableChanges();" class="w3-button w3-round w3-green w3-right">Save Changes</button>

        </div>
        
    </div>

    <script type="text/javascript">

        function saveTableChanges() {
            let tableElement = document.getElementById("table_join_requests");
            let tableRows = tableElement.rows;
            let cellIdx = tableRows[0].cells.length - 1;
            let statusCounts = {pending: 0, admin: 0, denied: 0, member: 0};
            let payload = {}, statusElement = null;
            for (let rowIdx = 1; rowIdx < tableRows.length; rowIdx++) {
                statusElement = tableRows[rowIdx].cells[cellIdx].children[0];
                payload[statusElement.name] = statusElement.value;
                statusCounts[statusElement.value] += 1;
            }
            
            if (statusCounts.admin < 1) {
                alert("The league must have at least 1 admin");
                return;
            } else {
                sendHTTPRequest("POST", document.URL, payload)
                    .then((response) => {
                        response = JSON.parse(response);
                        if (!response.success) {
                            alert(response.message);
                        } else {
                            for (let rowIdx = 1; rowIdx < tableRows.length; rowIdx++) {
                                statusElement = tableRows[rowIdx].cells[cellIdx].children[0];
                                statusElement.value = response.message[statusElement.name];
                            }
                            document.getElementById("num_players").innerText = statusCounts.admin + statusCounts.member;
                            alert("Changes updated!")
                        }
                    })
                    .catch((err) => { alert(err.message); })
            }
        }
    
    </script>

{% endblock %}

